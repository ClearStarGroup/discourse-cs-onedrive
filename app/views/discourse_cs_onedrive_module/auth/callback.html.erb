<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Connecting to OneDriveâ€¦</title>
    <script src="<%= Discourse.base_path %>/plugins/discourse-cs-onedrive/javascripts/vendor/msal-browser.min.js" nonce="<%= csp_nonce_placeholder %>"></script>
  </head>
  <body>
    <script nonce="<%= csp_nonce_placeholder %>">
    (async function () {
      if (!window.msal) {
        console.error("MSAL library not available");
        window.location.replace("<%= Discourse.base_path %>");
        return;
      }

      const clientId = "<%= SiteSetting.discourse_cs_onedrive_client_id %>";
      const tenantId = "<%= SiteSetting.discourse_cs_onedrive_tenant_id %>";
      
      if (!clientId || !tenantId || tenantId === "common") {
        console.error("OneDrive configuration is missing or invalid");
        window.location.replace("<%= Discourse.base_path %>");
        return;
      }

      const configuration = {
        auth: {
          clientId: clientId,
          authority: "https://login.microsoftonline.com/" + tenantId,
          redirectUri: "<%= Discourse.base_url %>/discourse-cs-onedrive/auth/callback",
        },
        cache: {
          cacheLocation: "sessionStorage",
          storeAuthStateInCookie: true,
        },
      };

      try {
        const client = new msal.PublicClientApplication(configuration);
        await client.initialize();
        await client.handleRedirectPromise();
      } catch (e) {
        console.error("MSAL redirect handling failed", e);
      } finally {
        const target = sessionStorage.getItem("csod.msal.redirect") || Discourse.base_path;
        sessionStorage.removeItem("csod.msal.redirect");
        window.location.replace(target);
      }
    })();
    </script>
  </body>
</html>
